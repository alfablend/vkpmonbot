<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ВКП</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }
    
    .header {
      align-items: left;
      background-color: #D9AB35;
      margin-left: 0px;
      margin-right: 0px;
      padding: 10px;
    }
    
    .column1 {
      float: left;
      width: 70%;
    }

    .column2 {
      float: left;
      width: 30%;
    }
    
    .row:after {
      content: "";
      display: table;
      clear: both;
    }
    
    .item {
      margin-top: 20px;
      margin-left: 100px;
      margin-right: 2%;
      padding: 15px 100px 75px 100px;
      font-size: larger;
      line-height: 1.5;
      background-color: #F9F2E1;
      border: 1px solid #E9CE8B;
      border-radius: 5px;
    }
        
    .button {
      background-color: #352909;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      margin-left: 100px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    
    .button:hover {
      background-color: #5a4a1a;
    }

    /* Стили для прогресс-бара */
    .progress-container {
      display: flex;
      flex-direction: column;
      margin-top: 15px;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #f1f1f1;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .status-container {
      margin: auto;
      width: 100%;
    }

    .status h3 {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    hr {
      border: 0;
      height: 1px;
      background-color: #ddd;
      margin: 10px 0;
    }
    
    /* Адаптивность для мобильных устройств */
    @media screen and (max-width: 768px) {
      .column1, .column2 {
        width: 100%;
      }
      
      .item {
        margin-left: 10px;
        margin-right: 10px;
        padding: 15px;
      }
      
      .button {
        margin-left: 10px;
        padding: 10px 20px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="restart" class="button">Обновить всё</a>
    <a href="repair" class="button">Исправить</a>
    <a href="only_gasn" class="button">Только ГАСН</a>
    <a href="only_gike" class="button">ГИКЭ и связанные</a>
  </header> 
  
  <div class="row">
    <div class="column1">
      {% for post in posts %} 
        {% if "fontan" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">"Фонтанка"</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>
        {% elif "gasn" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Разрешение Госстройнадзора</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>        
        {% elif "slush" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Общественные слушания</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>            
        {% elif "dp" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">"ДП"</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>    
        {% elif "egrz" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Заключение ЕГРЗ</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>    
        {% elif "antikor" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Антикоррупционная экспертиза</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>
        {% elif "opub" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Официальное электронное опубликование</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>
        {% elif "zakupki" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Закупка</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>
        {% elif "arbitr" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Арбитражное дело</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>    
        {% elif "gike" in post.type %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">Историко-культурная экспертиза</a></div>
            
            {% if post.image_path %}
              <center>
                <p>
                  <img src='/get_image/{{post.image_path}}' 
                       width="70%" 
                       style="display: block; max-width: 100%; height: auto; margin: 15px 0;"
                       alt='Изображение к новости'>
                </p>
              </center>
            {% endif %}    
            
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>    
        {% else %}
          <div class="item">
            <div style='text-align:right; width:100%'><p><i>{{post.date}}</i></p></div>
            <div style='text-align:center; width:100%'><a href="{{post.link}}" target="_blank">{{post.type}}</a></div>
            {% for paragraph in post.text %}
              <p>{{paragraph}}</p>
            {% endfor %}
          </div>
        {% endif %}    
      {% endfor %}
    </div>
    
    <div class="column2">    
      <div class="item" style="padding:20px; background-color: #f2f2f2; margin-left: 50px; margin-right: 25px;">
        <div class="status-container">
          <h3 id="innerStatus">Добро пожаловать!</h3>
          
          <div class="progress-container">
            <div class="progress-info">
              <span>Прогресс:</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressBar"></div>
            </div>
          </div>
          
          <hr>
          <div><strong>Всего записей:</strong> {{count_of_posts}}</div>
          <hr>
          <div><strong>Последнее обновление:</strong> {{time_of_coverage}}</div>
          <hr>
          <div><strong>Совет:</strong> используйте клавишу Tab для быстрого перехода между записями</div>
        </div>
      </div>
    </div>    
  </div>

  <script>
    let timeout;
    let progress = 0;

    async function updateProgressBar(value) {
      const progressBar = document.getElementById('progressBar');
      const progressPercent = document.getElementById('progressPercent');
      
      progressBar.style.width = value + '%';
      progressPercent.textContent = Math.round(value) + '%';
    }

    async function getStatus() {
      try {
        const response = await fetch("/status");
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        progress = Math.round((data.status / {{total_mons}}) * 100);
        
        document.getElementById("innerStatus").textContent = 
          progress < 100 ? `Собрано данных: ${progress}%` : "Сбор данных завершён";
        
        await updateProgressBar(progress);
        
        if (progress >= 100) {
          clearTimeout(timeout);
          return;
        }
        
        timeout = setTimeout(getStatus, 2000);
      } catch (error) {
        console.error("Error fetching status:", error);
        document.getElementById("innerStatus").textContent = "Ошибка получения статуса";
        clearTimeout(timeout);
      }
    }

    // Запускаем при полной загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
      updateProgressBar(0);
      getStatus();
    });
  </script>
</body>
</html>